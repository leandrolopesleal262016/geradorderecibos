<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Recibos</title>

    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://code.jquery.com https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; img-src 'self' data:;">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
    <style>
        .logo-container {
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            margin-bottom: 15px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            padding: 10px;
        }
        
        .select2-container .select2-selection--multiple {
            min-height: 38px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .select2-container {
            width: 100% !important;
            margin-bottom: 10px;
        }
        
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .linha-recibo[contenteditable="true"] {
            padding: 5px;
            border: 1px dashed #ccc;
            background-color: #f8f9fa;
        }
        
        .modelo-recibo {
            transition: all 0.3s ease;
        }
        
        .modelo-recibo:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .modelo-recibo.selected {
            border: 2px solid #0d6efd;
        }

        .modelo-preview textarea {
            width: 100%;
            min-height: 200px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>       
    <nav class="navbar navbar-dark bg-primary">
        <div class="container d-flex justify-content-between">
            <span class="navbar-brand mb-0 h1">Sistema de Geração de Recibos</span>
            <div>
                <a href="/consulta_recibos" class="btn btn-light">
                    <i class="bi bi-search"></i> Consultar Recibos
                </a>
                <a href="/consulta_clientes" class="btn btn-light ms-2">
                    <i class="bi bi-people"></i> Consultar Clientes
                </a>
            </div>
        </div>
    </nav>
    <div class="container mt-5">
        <!-- <h2 class="mb-4">Gerador de Recibos</h2> -->

<!-- Seleção de modelo -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">Selecione o modelo de recibo:</h4>
        <div class="d-flex gap-4 flex-wrap">
            <!-- Modelo 1 -->
            <div class="card modelo-recibo" style="width: 300px; cursor: pointer;" data-modelo="1">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Modelo Emitente</h5>
                    <button class="btn btn-sm btn-primary editar-modelo" data-modelo="1">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                </div>
                <div class="card-body">
                    <img src="/static/images/logo.png" alt="Logo Bencato" style="width: 100px; margin-bottom: 10px;">
                    <div class="modelo-preview p-2 border rounded" style="font-size: 0.8em;">
                        <p class="mb-1"><strong>RECIBO Nº XXXXX - parcela única</strong></p>
                        <p class="mb-1">ADMINISTRATIVO - Nome do Cliente</p>
                        <p class="mb-1">Recebi(emos) a quantia de R$ XXX,XX</p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modeloRecibo" id="modelo1" value="1" checked>
                        <label class="form-check-label" for="modelo1">Selecionar este modelo</label>
                    </div>
                </div>
            </div>
            
            <!-- Modelo 2 -->
            <div class="card modelo-recibo" style="width: 300px; cursor: pointer;" data-modelo="2">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Modelo Destinatário</h5>
                    <button class="btn btn-sm btn-primary editar-modelo" data-modelo="2">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                </div>
                <div class="card-body">
                    <img src="/static/images/logo.png" alt="Logo Bencato" style="width: 100px; margin-bottom: 10px;">
                    <div class="modelo-preview p-2 border rounded" style="font-size: 0.8em;">
                        <p class="mb-1"><strong>RECIBO Nº XXXXX - parcela única</strong></p>
                        <p class="mb-1">Recebemos de CLIENTE a quantia de R$ XXX,XX</p>
                        <p class="mb-1">correspondente a ...</p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modeloRecibo" id="modelo2" value="2">
                        <label class="form-check-label" for="modelo2">Selecionar este modelo</label>
                    </div>
                </div>
            </div>

            <!-- Modelo 3 -->
            <div class="card modelo-recibo" style="width: 300px; cursor: pointer;" data-modelo="3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Modelo Personalizado</h5>
                    <button class="btn btn-sm btn-primary editar-modelo" data-modelo="3">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                </div>
                <div class="card-body">
                    <img src="/static/images/logo.png" alt="Logo Bencato" style="width: 100px; margin-bottom: 10px;">
                    <div class="modelo-preview p-2 border rounded" style="font-size: 0.8em;">
                        <p class="mb-1"><strong>RECIBO Nº XXXXX</strong></p>
                        <p class="mb-1">Modelo Personalizado</p>
                        <p class="mb-1">Clique em Editar para personalizar</p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modeloRecibo" id="modelo3" value="3">
                        <label class="form-check-label" for="modelo3">Selecionar este modelo</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botão Novo Cliente -->
<div class="row mb-4">
    <div class="col-12">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoClienteModal">
            <i class="bi bi-person-plus"></i> Novo Cliente
        </button>
    </div>
</div>

<!-- Seleção de Clientes -->
<div class="row mb-4">
    <div class="col-md-6">
        <label for="empresas" class="form-label">Empresas:</label>
        <select id="empresas" class="form-control select2" multiple>
        </select>
    </div>
    <div class="col-md-6">
        <label for="pessoas" class="form-label">Pessoas Físicas:</label>
        <button id="selectAllPessoas" class="btn btn-secondary btn-sm mb-2">Selecionar Todas</button>
        <select id="pessoas" class="form-control select2" multiple>
        </select>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <label for="valor" class="form-label">Valor (R$):</label>
        <input type="text" id="valor" class="form-control" placeholder="0,00">
    </div>
   
    <div class="col-md-4">
        <label for="data" class="form-label">Data:</label>
        <input type="date" id="data" class="form-control" value="<?php echo date('Y-m-d'); ?>">
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <button id="gerarRecibos" class="btn btn-primary">Gerar Recibos</button>
        <button id="downloadRecibos" class="btn btn-success ms-2" style="display: none;">Download</button>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div id="previewArea" style="width: 100%; display: none;">
            <h3>Prévia dos Recibos</h3>
            <div id="recibosPreview" class="mt-3">
            </div>
        </div>
    </div>
</div>

<!-- Modal de Cadastro de Cliente -->
<div class="modal fade" id="novoClienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cadastrar Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNovoCliente">
                    <div class="mb-3">
                        <label for="razaoSocial" class="form-label">Razão Social/Nome</label>
                        <input type="text" class="form-control" id="razaoSocial" required>
                    </div>
                    <div class="mb-3">
                        <label for="cpfCnpj" class="form-label">CPF/CNPJ</label>
                        <input type="text" class="form-control" id="cpfCnpj" required>
                    </div>
                    <div class="mb-3">
                        <label for="tipoCliente" class="form-label">Tipo</label>
                        <select class="form-control" id="tipoCliente" required>
                            <option value="pessoa">Pessoa Física</option>
                            <option value="empresa">Pessoa Jurídica</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvarCliente">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição de Modelo -->
<div class="modal fade" id="modeloEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Modelo de Recibo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Logo Upload Section -->
                <div class="mb-3">
                    <label class="form-label">Logo do Recibo:</label>
                    <input type="file" class="form-control" id="modeloLogo" accept="image/*">
                    <div class="mt-2">
                        <img id="logoPreview" src="" alt="Logo Preview" style="max-width: 200px; display: none;">
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="mostrarLogo" checked>
                        <label class="form-check-label" for="mostrarLogo">
                            Mostrar logo no recibo
                        </label>
                    </div>
                </div>
                
                <!-- Header Text Section -->
                <div class="mb-3">
                    <label class="form-label">Texto do Cabeçalho:</label>
                    <textarea class="form-control" id="modeloHeader" rows="3"></textarea>
                </div>
                
                <!-- Existing Fields -->
                <div class="mb-3">
                    <label class="form-label">Nome do Modelo:</label>
                    <input type="text" class="form-control" id="modeloNome">
                </div>
                <div class="mb-3">
                    <label class="form-label">Conteúdo do Modelo:</label>
                    <textarea class="form-control" id="modeloConteudo" rows="10"></textarea>
                </div>
            </div>
            <div class="modal-footer flex-column">
                <div class="w-100 text-muted small mb-3 border-bottom pb-2">
                    <p class="fw-bold mb-1">Variáveis disponíveis para uso no modelo:</p>
                    <div class="d-flex flex-wrap gap-2">
                        <code>{cliente_nome}</code> - Nome do cliente
                        <code>{valor}</code> - Valor do recibo
                        <code>{valor_extenso}</code> - Valor por extenso
                        <code>{numero_recibo}</code> - Número do recibo
                        <code>{data}</code> - Data atual
                        <code>{documento_cliente}</code> - CPF/CNPJ do cliente
                    </div>
                </div>
                <div class="w-100 d-flex justify-content-end">
                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarModelo">Salvar Modelo</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // Inicialização básica do Select2
        $('.select2').select2({
            width: '100%',
            placeholder: 'Selecione os clientes',
            allowClear: true
        });

        // Carregamento dos clientes
        fetch('/get_clientes')
            .then(response => response.json())
            .then(data => {
                const empresasSelect = $('#empresas');
                const pessoasSelect = $('#pessoas');
                
                // Limpa os selects antes de adicionar novos dados
                empresasSelect.empty();
                pessoasSelect.empty();
                
                // Adiciona as empresas
                data.empresas.forEach(empresa => {
                    empresasSelect.append(new Option(empresa, empresa));
                });
                
                // Adiciona as pessoas físicas
                data.pessoas.forEach(pessoa => {
                    pessoasSelect.append(new Option(pessoa, pessoa));
                });
                
                // Atualiza os selects
                empresasSelect.trigger('change');
                pessoasSelect.trigger('change');
            })
            .catch(error => {
                console.log('Erro ao carregar clientes:', error);
            });
    });

        let previewData = null;
                  // Modelos de recibo
                  let modelos = {
                      1: {
                          nome: "Modelo Emitente",
                          conteudo: `RECIBO Nº {numero_recibo} - parcela única     VALOR: R$ {valor}
                  ADMINISTRATIVO - {cliente_nome}
                  Recebi(emos) a quantia de R$ {valor} ({valor_extenso}) na forma de pagamento Conciliação...`
                      },
                      2: {
                          nome: "Modelo Destinatário",
                          conteudo: `RECIBO Nº {numero_recibo} - parcela única     VALOR: R$ {valor}
                  {cliente_nome}
                  Recebemos de BENCATO CONSTRUCOES LTDA a quantia de R$ {valor} ({valor_extenso})...`
                      },
                      3: {
                          nome: "Modelo Personalizado",
                          conteudo: `RECIBO Nº {numero_recibo}
                  Valor: R$ {valor}
                  Cliente: {cliente_nome}...`
                      }
                  };

                  function atualizarLogoModelo(modeloId, logoPath) {
                        const modeloCard = $(`.modelo-recibo[data-modelo="${modeloId}"]`);
                        modeloCard.find('img').attr('src', logoPath);
                    }

                function carregarModelos() {
                    fetch('/modelos')
                        .then(response => response.json())
                        .then(modelosData => {
                            modelosData.forEach(modelo => {
                                const modeloCard = $(`.modelo-recibo[data-modelo="${modelo.id}"]`);
                                
                                // Atualiza nome
                                modeloCard.find('.card-header h5').text(modelo.nome);
                                
                                // Atualiza logo
                                if (modelo.logo_path) {
                                    atualizarLogoModelo(modelo.id, modelo.logo_path);
                                }
                                
                                // Atualiza preview
                                let previewHtml = '';
                                if (modelo.header_text) {
                                    previewHtml += `<p class="mb-1">${modelo.header_text}</p>`;
                                }
                                previewHtml += formatarPreview(modelo.conteudo);
                                modeloCard.find('.modelo-preview').html(previewHtml);
                                
                                // Atualiza objeto local
                                modelos[modelo.id] = modelo;
                            });
                        })
                        .catch(error => {
                            console.error('Erro ao carregar modelos:', error);
                        });
                }
                  // Seleção de modelo
                  $('.modelo-recibo').click(function() {
                      const modeloId = $(this).data('modelo');
                      $(`#modelo${modeloId}`).prop('checked', true);
                      $('.modelo-recibo').removeClass('selected');
                      $(this).addClass('selected');
                  });

                // Edição de modelo
                    $('.editar-modelo').click(function(e) {
                        e.stopPropagation();
                        const modeloId = $(this).data('modelo');
                        const modelo = modelos[modeloId];

                        // Busca o valor salvo no localStorage ou usa true como padrão
                        const savedValue = localStorage.getItem('mostrarLogo');
                        $('#mostrarLogo').prop('checked', savedValue === null || savedValue !== 'false');
                        
                        $('#modeloNome').val(modelo.nome);
                        $('#modeloConteudo').val(modelo.conteudo);
                        $('#modeloHeader').val(modelo.header_text || '');
                        $('#modeloEditModal').data('modelo-id', modeloId);

                        const modal = new bootstrap.Modal(document.getElementById('modeloEditModal'));
                        modal.show();
                    });

                
                // Atualiza o código de upload da logo
                $('#salvarModelo').click(function() {
                    const modeloId = $('#modeloEditModal').data('modelo-id');
                    const formData = new FormData();
                    
                    formData.append('modelo_id', modeloId);
                    formData.append('nome', $('#modeloNome').val());
                    formData.append('header_text', $('#modeloHeader').val());
                    formData.append('conteudo', $('#modeloConteudo').val());
                    
                    const logoFile = $('#modeloLogo')[0].files[0];
                    if (logoFile) {
                        formData.append('logo', logoFile);
                        
                        fetch('/upload_logo', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Atualiza imediatamente a visualização da logo
                                atualizarLogoModelo(modeloId, data.logo_path);
                                
                                // Salva os dados do modelo
                                saveModelData(modeloId, data.logo_path);
                            } else {
                                throw new Error(data.error || 'Erro no upload da logo');
                            }
                        })
                        .catch(error => {
                            console.error('Erro:', error);
                            alert('Erro ao fazer upload da logo');
                        });
                    } else {
                        saveModelData(modeloId);
                    }
                });
                function saveModelData(modeloId, logoPath = null) {
                    const dados = {
                        modelo_id: modeloId,
                        nome: $('#modeloNome').val(),
                        header_text: $('#modeloHeader').val(),
                        conteudo: $('#modeloConteudo').val()
                    };
                    
                    if (logoPath) {
                        dados.logo_path = logoPath.replace('\\', '/');
                    }

                    fetch('/salvar_modelo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dados)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.status === 'sucesso') {
                            const modeloCard = $(`.modelo-recibo[data-modelo="${modeloId}"]`);
                            
                            // Atualiza logo se houver
                            if (logoPath) {
                                const finalPath = logoPath.startsWith('/') ? logoPath : '/' + logoPath;
                                modeloCard.find('img')
                                    .attr('src', finalPath)
                                    .attr('alt', `Logo ${dados.nome}`);
                            }
                            
                            // Atualiza outros elementos
                            modeloCard.find('.card-header h5').text(dados.nome);
                            const previewContent = [];
                            if (dados.header_text) {
                                previewContent.push(`<p class="mb-1">${dados.header_text}</p>`);
                            }
                            previewContent.push(formatarPreview(dados.conteudo));
                            modeloCard.find('.modelo-preview').html(previewContent.join(''));
                            
                            $('#modeloEditModal').modal('hide');
                            alert('Modelo salvo com sucesso!');
                        }
                    })
                    .catch(error => {
                        console.error("Erro:", error);
                        alert('Erro ao salvar modelo');
                    });
                }
                // Adicione esta função para pré-visualizar a logo selecionada
                $('#modeloLogo').change(function() {
                    const file = this.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            $('#logoPreview')
                                .attr('src', e.target.result)
                                .css('display', 'block');
                        };
                        reader.readAsDataURL(file);
                    }
                });

                    function atualizarPreviewModelo(modeloId, logoPath, headerText) {
                        const modeloCard = $(`.modelo-recibo[data-modelo="${modeloId}"]`);
                        
                        // Atualiza logo
                        if (logoPath) {
                            modeloCard.find('img').attr('src', logoPath);
                        }
                        
                        // Atualiza texto do cabeçalho
                        if (headerText) {
                            const headerPreview = modeloCard.find('.modelo-preview p:first');
                            if (headerPreview.length) {
                                headerPreview.text(headerText);
                            } else {
                                modeloCard.find('.modelo-preview').prepend(`<p class="mb-1">${headerText}</p>`);
                            }
                        }
                    }

                  // Formatar preview
                  function formatarPreview(conteudo) {
                      return conteudo
                          .replace(/{numero_documento}/g, 'XXXXX')
                          .replace(/{valor}/g, 'XXX,XX')
                          .replace(/{cliente_nome}/g, 'Nome do Cliente')
                          .replace(/{valor_extenso}/g, 'valor por extenso')
                          .split('\n')
                          .map(linha => `<p class="mb-1">${linha}</p>`)
                          .join('');
                  }

                  // Carregar modelos ao iniciar
                  $(document).ready(function() {
                      carregarModelos();
                  });
            // Selecionar todas as pessoas
            $('#selectAllPessoas').click(function() {
                const pessoasSelect = $('#pessoas');
                const todasOpcoes = pessoasSelect.find('option').map(function() {
                    return this.value;
                }).get();
                
                pessoasSelect.select2('destroy');
                pessoasSelect.val(todasOpcoes);
                pessoasSelect.select2();
                
                console.log("Opções selecionadas:", todasOpcoes);
            });   

            $('#gerarRecibos').click(function() {
                const modeloId = $('input[name="modeloRecibo"]:checked').val();
                const empresasSelecionadas = $('#empresas').val() || [];
                const pessoasSelecionadas = $('#pessoas').val() || [];
                const todosSelecionados = [...empresasSelecionadas, ...pessoasSelecionadas];
                const valor = $('#valor').val();
                const dataSelecionada = $('#data').val(); // Captura a data selecionada

                if (todosSelecionados.length === 0) {
                    alert('Por favor, selecione pelo menos um cliente.');
                    return;
                }

                if (!valor) {
                    alert('Por favor, insira um valor.');
                    return;
                }

                fetch('/generate_receipts_bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        modelo: modeloId,
                        modeloConteudo: $('.modelo-recibo[data-modelo="' + modeloId + '"] .modelo-preview').text(),
                        clientes: todosSelecionados,
                        valor: valor,
                        data: data,
                        mostrarLogo: localStorage.getItem('mostrarLogo') !== 'false' // Nova linha
                    })
                })

                .then(response => response.json())
                .then(data => {
                    if (!data.preview || !Array.isArray(data.preview)) {
                        throw new Error('Formato de dados inválido');
                    }
                    
                    previewData = data;  // Armazena os dados, incluindo os IDs
                    const previewArea = $('#previewArea');
                    const recibosPreview = $('#recibosPreview');
                    
                    recibosPreview.empty();
                    
                    data.preview.forEach(recibo => {
                        const reciboHtml = `
                            <div class="card mb-3" data-recibo-id="${recibo.id}">  <!-- Armazena o ID aqui -->
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${recibo.nome}</h5>
                                    <button class="btn btn-light btn-sm editar-recibo">Editar</button>
                                </div>
                                <div class="card-body">
                                    ${recibo.conteudo.map(linha => `
                                        <p class="linha-recibo"
                                           data-index="${recibo.conteudo.indexOf(linha)}"
                                           contenteditable="false">${linha}</p>
                                    `).join('')}
                                </div>
                                <div class="card-footer" style="display: none;">
                                    <button class="btn btn-success btn-sm salvar-recibo me-2">Salvar</button>
                                    <button class="btn btn-danger btn-sm cancelar-edicao">Cancelar</button>
                                </div>
                            </div>
                        `;
                        recibosPreview.append(reciboHtml);
                    });
                    
                    previewArea.show();
                    $('#downloadRecibos').show();
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao gerar recibos. Por favor, verifique os dados e tente novamente.');
                });
            });            
            // Editar recibo individual
            $(document).on('click', '.editar-recibo', function() {
                const card = $(this).closest('.card');
                card.find('.linha-recibo').attr('contenteditable', 'true');
                card.find('.card-footer').show();
                $(this).hide();
            });

            // Salvar recibo editado (agora usa o data-recibo-id do card)
            $(document).on('click', '.salvar-recibo', function() {
                const card = $(this).closest('.card');
                const reciboId = card.data('recibo-id');
                const conteudoAtualizado = [];

                card.find('.linha-recibo').each(function() {
                    conteudoAtualizado.push($(this).text().trim());
                });

                fetch('/atualizar_recibo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recibo_id: reciboId,
                        conteudo: conteudoAtualizado,
                        data: $('#data').val() // Envia a data atual do formulário
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'sucesso') {
                        console.log("Recibo atualizado com sucesso no banco de dados");
                        alert('Recibo atualizado com sucesso!');
                        card.find('.linha-recibo').attr('contenteditable', 'false');
                        card.find('.card-footer').hide();
                        card.find('.editar-recibo').show();
                    } else {
                        console.error("Erro ao atualizar recibo:", data.mensagem);
                        alert('Erro ao atualizar recibo: ' + data.mensagem);
                    }
                })
                .catch(error => {
                    console.error("Erro na requisição:", error);
                    alert('Erro ao processar a atualização do recibo');
                });
            });

            // Cancelar edição do recibo
            $(document).on('click', '.cancelar-edicao', function() {
                const card = $(this).closest('.card');
                const reciboIndex = card.index();
                
                card.find('.linha-recibo').each(function(index) {
                    $(this).text(previewData.preview[reciboIndex].conteudo[index]);
                });
                
                card.find('.linha-recibo').attr('contenteditable', 'false');
                card.find('.card-footer').hide();
                card.find('.editar-recibo').show();
            });

            $('#downloadRecibos').click(function(e) {
            e.preventDefault();
            
            // Coleta os IDs dos recibos na prévia
            const recibosIds = [];
            $('.card[data-recibo-id]').each(function() {
                recibosIds.push($(this).data('recibo-id'));
            });
            
            fetch('/download_recibos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    recibos: recibosIds
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'recibos.zip';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            })
            .catch(error => {
                console.error('Erro no download:', error);
                alert('Erro ao baixar os recibos');
            });
        });


      $(document).ready(function() {
          function formatarValor(valor) {
              valor = valor.replace(/\D/g, '');
              valor = (parseInt(valor) / 100).toFixed(2);
              valor = valor.replace('.', ',');
              valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
              return valor;
          }

          $('#valor').on('input', function() {
              let valorAtual = $(this).val().replace(/\D/g, '');
              if (valorAtual) {
                  $(this).val(formatarValor(valorAtual));
              }
          });
      }); 

    // Função para formatar CPF/CNPJ
    function formatarDocumento(documento) {
        // Remove caracteres não numéricos
        documento = documento.replace(/\D/g, '');
        
        if (documento.length <= 11) {
            // Formato CPF: 000.000.000-00
            return documento.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/g, "$1.$2.$3-$4");
        } else {
            // Formato CNPJ: 00.000.000/0000-00
            return documento.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g, "$1.$2.$3/$4-$5");
        }
    }

    // Máscara para CPF/CNPJ
    $('#cpfCnpj').on('input', function() {
        $(this).val(formatarDocumento($(this).val()));
    });

    // Salvar novo cliente
    $('#salvarCliente').click(function() {
        const razaoSocial = $('#razaoSocial').val();
        const cpfCnpj = $('#cpfCnpj').val().replace(/\D/g, '');
        const tipo = $('#tipoCliente').val();

        if (!razaoSocial || !cpfCnpj) {
            alert('Preencha todos os campos!');
            return;
        }

        fetch('/add_cliente', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                razao_social: razaoSocial,
                cpf_cnpj: cpfCnpj,
                tipo: tipo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                alert('Cliente cadastrado com sucesso!');
                $('#novoClienteModal').modal('hide');
                
                // Limpa os campos do formulário
                $('#razaoSocial').val('');
                $('#cpfCnpj').val('');
                
                // Atualiza as listas de clientes
                fetch('/get_clientes')
                    .then(response => response.json())
                    .then(data => {
                        const empresasSelect = $('#empresas');
                        const pessoasSelect = $('#pessoas');
                        
                        // Limpa os selects
                        empresasSelect.empty();
                        pessoasSelect.empty();
                        
                        // Adiciona as empresas atualizadas
                        data.empresas.forEach(empresa => {
                            empresasSelect.append(new Option(empresa, empresa));
                        });
                        
                        // Adiciona as pessoas físicas atualizadas
                        data.pessoas.forEach(pessoa => {
                            pessoasSelect.append(new Option(pessoa, pessoa));
                        });
                        
                        // Atualiza os selects
                        empresasSelect.trigger('change');
                        pessoasSelect.trigger('change');
                    });
            }
        })
        .catch(error => {
            alert('Erro ao cadastrar cliente');
            console.error('Erro:', error);
        });
    });

        
        $('#salvarCliente').click(function() {
        
    });

    
    $(document).ready(function() {
        // Define a data atual como valor padrão
        const hoje = new Date().toISOString().split('T')[0];
        $('#data').val(hoje);
    });

    // Carregar modelos ao iniciar
    $(document).ready(function() {
        carregarModelos();
    });

    // Gerenciar preferência de exibição de logo
    // Gerenciar preferência de exibição de logo
    $(document).ready(function() {
        // Verificamos se existe um valor no localStorage
        const savedValue = localStorage.getItem('mostrarLogo');
        
        // Se não existir valor OU o valor for diferente de 'false', marcamos o checkbox
        $('#mostrarLogo').prop('checked', savedValue === null || savedValue !== 'false');
        
        // Salva a preferência quando o checkbox é alterado
        $('#mostrarLogo').change(function() {
            localStorage.setItem('mostrarLogo', $(this).prop('checked'));
        });
        
        console.log('Estado inicial do checkbox mostrarLogo:', $('#mostrarLogo').prop('checked'));
    });



</script>
   
<footer class="bg-light py-3 text-center mt-5">
    <p class="mb-0">Desenvolvido por Leandro Leal - 2025</p>
</footer>

</body>
</html>
    