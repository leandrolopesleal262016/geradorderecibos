<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Recibos</title>

    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://code.jquery.com https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; img-src 'self' data:;">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
    <style>
        .select2-container .select2-selection--multiple {
            min-height: 38px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .select2-container {
            width: 100% !important;
            margin-bottom: 10px;
        }
        
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .linha-recibo[contenteditable="true"] {
            padding: 5px;
            border: 1px dashed #ccc;
            background-color: #f8f9fa;
        }
        
        .modelo-recibo {
            transition: all 0.3s ease;
        }
        
        .modelo-recibo:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .modelo-recibo.selected {
            border: 2px solid #0d6efd;
        }

        .modelo-preview textarea {
            width: 100%;
            min-height: 200px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>       
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand mb-0 h1">Sistema de Geração de Recibos</span>
        </div>
    </nav>
    <div class="container mt-5">
        <!-- <h2 class="mb-4">Gerador de Recibos</h2> -->

<!-- Seleção de modelo -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">Selecione o modelo de recibo:</h4>
        <div class="d-flex gap-4 flex-wrap">
            <!-- Modelo 1 -->
            <div class="card modelo-recibo" style="width: 300px; cursor: pointer;" data-modelo="1">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Modelo Emitente</h5>
                    <button class="btn btn-sm btn-primary editar-modelo" data-modelo="1">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                </div>
                <div class="card-body">
                    <img src="/static/images/logo.png" alt="Logo Bencato" style="width: 100px; margin-bottom: 10px;">
                    <div class="modelo-preview p-2 border rounded" style="font-size: 0.8em;">
                        <p class="mb-1"><strong>RECIBO Nº XXXXX - parcela única</strong></p>
                        <p class="mb-1">ADMINISTRATIVO - Nome do Cliente</p>
                        <p class="mb-1">Recebi(emos) a quantia de R$ XXX,XX</p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modeloRecibo" id="modelo1" value="1" checked>
                        <label class="form-check-label" for="modelo1">Selecionar este modelo</label>
                    </div>
                </div>
            </div>
            
            <!-- Modelo 2 -->
            <div class="card modelo-recibo" style="width: 300px; cursor: pointer;" data-modelo="2">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Modelo Destinatário</h5>
                    <button class="btn btn-sm btn-primary editar-modelo" data-modelo="2">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                </div>
                <div class="card-body">
                    <img src="/static/images/logo.png" alt="Logo Bencato" style="width: 100px; margin-bottom: 10px;">
                    <div class="modelo-preview p-2 border rounded" style="font-size: 0.8em;">
                        <p class="mb-1"><strong>RECIBO Nº XXXXX - parcela única</strong></p>
                        <p class="mb-1">Recebemos de CLIENTE a quantia de R$ XXX,XX</p>
                        <p class="mb-1">correspondente a ...</p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modeloRecibo" id="modelo2" value="2">
                        <label class="form-check-label" for="modelo2">Selecionar este modelo</label>
                    </div>
                </div>
            </div>

            <!-- Modelo 3 -->
            <div class="card modelo-recibo" style="width: 300px; cursor: pointer;" data-modelo="3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Modelo Personalizado</h5>
                    <button class="btn btn-sm btn-primary editar-modelo" data-modelo="3">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                </div>
                <div class="card-body">
                    <img src="/static/images/logo.png" alt="Logo Bencato" style="width: 100px; margin-bottom: 10px;">
                    <div class="modelo-preview p-2 border rounded" style="font-size: 0.8em;">
                        <p class="mb-1"><strong>RECIBO Nº XXXXX</strong></p>
                        <p class="mb-1">Modelo Personalizado</p>
                        <p class="mb-1">Clique em Editar para personalizar</p>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modeloRecibo" id="modelo3" value="3">
                        <label class="form-check-label" for="modelo3">Selecionar este modelo</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seleção de Clientes -->
<div class="row mb-4">
    <div class="col-md-6">
        <label for="empresas" class="form-label">Empresas:</label>
        <select id="empresas" class="form-control select2" multiple>
        </select>
    </div>
    <div class="col-md-6">
        <label for="pessoas" class="form-label">Pessoas Físicas:</label>
        <button id="selectAllPessoas" class="btn btn-secondary btn-sm mb-2">Selecionar Todas</button>
        <select id="pessoas" class="form-control select2" multiple>
        </select>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-4">
        <label for="valor" class="form-label">Valor (R$):</label>
        <input type="text" id="valor" class="form-control" placeholder="0,00">
    </div>
    <div class="col-md-4">
        <label for="numero_documento" class="form-label">Número do Documento:</label>
        <input type="text" id="numero_documento" class="form-control">
    </div>
    <div class="col-md-4">
        <label for="data" class="form-label">Data:</label>
        <input type="date" id="data" class="form-control" value="<?php echo date('Y-m-d'); ?>">
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <button id="gerarRecibos" class="btn btn-primary">Gerar Recibos</button>
        <button id="downloadRecibos" class="btn btn-success ms-2" style="display: none;">Download</button>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div id="previewArea" style="width: 100%; display: none;">
            <h3>Prévia dos Recibos</h3>
            <div id="recibosPreview" class="mt-3">
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição de Modelo -->
<div class="modal fade" id="modeloEditModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Modelo de Recibo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nome do Modelo:</label>
                    <input type="text" class="form-control" id="modeloNome">
                </div>
                <div class="mb-3">
                    <label class="form-label">Conteúdo do Modelo:</label>
                    <textarea class="form-control" id="modeloConteudo" rows="10"></textarea>
                </div>
                <div class="form-text">
                    Variáveis disponíveis: {cliente_nome}, {valor}, {valor_extenso}, {numero_documento}, {data}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvarModelo">Salvar Modelo</button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // Inicialização do Select2
        $('.select2').select2({
            width: '100%',
            placeholder: 'Selecione os clientes',
            allowClear: true,
            theme: 'bootstrap4'
        });

        // Carregar clientes
        fetch('/get_clientes')
            .then(response => response.json())
            .then(data => {
                const empresasSelect = $('#empresas');
                const pessoasSelect = $('#pessoas');
                
                // Limpa os selects
                empresasSelect.empty();
                pessoasSelect.empty();
                
                // Adiciona as opções
                data.empresas.forEach(empresa => {
                    const option = new Option(empresa, empresa, false, false);
                    empresasSelect.append(option);
                });
                
                data.pessoas.forEach(pessoa => {
                    const option = new Option(pessoa, pessoa, false, false);
                    pessoasSelect.append(option);
                });
                
                // Atualiza o Select2
                empresasSelect.trigger('change');
                pessoasSelect.trigger('change');
            });

        let previewData = null;
        
        // Modelos de recibo
        let modelos = {
            1: {
                nome: "Modelo Emitente",
                conteudo: `RECIBO Nº {numero_documento} - parcela única     VALOR: R$ {valor}
ADMINISTRATIVO - {cliente_nome}
Recebi(emos) a quantia de R$ {valor} ({valor_extenso}) na forma de pagamento Conciliação, correspondente a VALE ALIMENTAÇÃO (documento número {numero_documento} parcela única) e para maior clareza firmo(amos) o presente.`
            },
            2: {
                nome: "Modelo Destinatário",
                conteudo: `RECIBO Nº {numero_documento} - parcela única     VALOR: R$ {valor}
{cliente_nome}
Recebemos de BENCATO CONSTRUCOES LTDA a quantia de R$ {valor} ({valor_extenso}) na forma de pagamento Conciliação, correspondente a PARCELA ADM OBRA - CONFORME CONTRATO (documento número {numero_documento} parcela única) e para maior clareza firmo(amos) o presente.`
            },
            3: {
                nome: "Modelo Personalizado",
                conteudo: `RECIBO Nº {numero_documento}
Valor: R$ {valor}
Cliente: {cliente_nome}
Texto personalizado aqui...`
            }
        };

        // Carregar modelos do localStorage, se existirem
        const modelosSalvos = localStorage.getItem('modelosRecibo');
        if (modelosSalvos) {
            modelos = JSON.parse(modelosSalvos);
        }

        // Seleção de modelo
        $('.modelo-recibo').click(function() {
            const modeloId = $(this).data('modelo');
            $(`#modelo${modeloId}`).prop('checked', true);
            $('.modelo-recibo').removeClass('selected');
            $(this).addClass('selected');
        });

        // Edição de modelo
        $('.editar-modelo').click(function(e) {
            e.stopPropagation();
            const modeloId = $(this).data('modelo');
            const modelo = modelos[modeloId];
            
            $('#modeloNome').val(modelo.nome);
            $('#modeloConteudo').val(modelo.conteudo);
            $('#modeloEditModal').data('modelo-id', modeloId);
            
            const modal = new bootstrap.Modal(document.getElementById('modeloEditModal'));
            modal.show();
        });

        // Salvar modelo
        $('#salvarModelo').click(function() {
            const modeloId = $('#modeloEditModal').data('modelo-id');
            const nome = $('#modeloNome').val();
            const conteudo = $('#modeloConteudo').val();
            
            modelos[modeloId] = {
                nome: nome,
                conteudo: conteudo
            };
            
            // Atualizar preview do modelo
            const modeloCard = $(`.modelo-recibo[data-modelo="${modeloId}"]`);
            modeloCard.find('.card-header h5').text(nome);
            modeloCard.find('.modelo-preview').html(formatarPreview(conteudo));
            
            // Salvar no localStorage
            localStorage.setItem('modelosRecibo', JSON.stringify(modelos));
                
                bootstrap.Modal.getInstance(document.getElementById('modeloEditModal')).hide();
            });

            // Formatar preview
            function formatarPreview(conteudo) {
                return conteudo
                    .replace(/{numero_documento}/g, 'XXXXX')
                    .replace(/{valor}/g, 'XXX,XX')
                    .replace(/{cliente_nome}/g, 'Nome do Cliente')
                    .replace(/{valor_extenso}/g, 'valor por extenso')
                    .split('\n')
                    .map(linha => `<p class="mb-1">${linha}</p>`)
                    .join('');
            }

            // Atualizar previews iniciais
            Object.keys(modelos).forEach(modeloId => {
                const modeloCard = $(`.modelo-recibo[data-modelo="${modeloId}"]`);
                modeloCard.find('.card-header h5').text(modelos[modeloId].nome);
                modeloCard.find('.modelo-preview').html(formatarPreview(modelos[modeloId].conteudo));
            });

            // Selecionar todas as pessoas
            $('#selectAllPessoas').click(function() {
                const pessoasSelect = $('#pessoas');
                const todasOpcoes = pessoasSelect.find('option').map(function() {
                    return this.value;
                }).get();
                
                pessoasSelect.select2('destroy');
                pessoasSelect.val(todasOpcoes);
                pessoasSelect.select2();
                
                console.log("Opções selecionadas:", todasOpcoes);
            });
    });

            // Gerar recibos
            $('#gerarRecibos').click(function() {
                const modeloSelecionado = $('input[name="modeloRecibo"]:checked').val();
                const empresasSelecionadas = $('#empresas').val() || [];
                const pessoasSelecionadas = $('#pessoas').val() || [];
                const todosSelecionados = [...empresasSelecionadas, ...pessoasSelecionadas];
                const valor = $('#valor').val();
                const numero_documento = $('#numero_documento').val();
                const data = $('#data').val();

                if (todosSelecionados.length === 0) {
                    alert('Por favor, selecione pelo menos um cliente.');
                    return;
                }

                if (!valor) {
                    alert('Por favor, insira um valor.');
                    return;
                }

                if (!numero_documento) {
                    alert('Por favor, insira um número de documento.');
                    return;
                }

                fetch('/generate_receipts_bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        modelo: modeloSelecionado,
                        clientes: todosSelecionados,
                        valor: valor,
                        numero_documento: numero_documento,
                        data: data
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.preview || !Array.isArray(data.preview)) {
                        throw new Error('Formato de dados inválido');
                    }
                    
                    previewData = data;
                    const previewArea = $('#previewArea');
                    const recibosPreview = $('#recibosPreview');
                    
                    recibosPreview.empty();
                    
                    data.preview.forEach(recibo => {
                        const reciboHtml = `
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${recibo.nome}</h5>
                                    <button class="btn btn-light btn-sm editar-recibo">Editar</button>
                                </div>
                                <div class="card-body">
                                    ${recibo.conteudo.map(linha => `
                                        <p class="linha-recibo" 
                                           data-index="${recibo.conteudo.indexOf(linha)}" 
                                           contenteditable="false">${linha}</p>
                                    `).join('')}
                                </div>
                                <div class="card-footer" style="display: none;">
                                    <button class="btn btn-success btn-sm salvar-recibo me-2">Salvar</button>
                                    <button class="btn btn-danger btn-sm cancelar-edicao">Cancelar</button>
                                </div>
                            </div>
                        `;
                        recibosPreview.append(reciboHtml);
                    });
                    
                    previewArea.show();
                    $('#downloadRecibos').show();
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao gerar recibos. Por favor, verifique os dados e tente novamente.');
                });
            });
            // Editar recibo individual
            $(document).on('click', '.editar-recibo', function() {
                const card = $(this).closest('.card');
                card.find('.linha-recibo').attr('contenteditable', 'true');
                card.find('.card-footer').show();
                $(this).hide();
            });

            // Salvar recibo editado
            $(document).on('click', '.salvar-recibo', function() {
                const card = $(this).closest('.card');
                card.find('.linha-recibo').attr('contenteditable', 'false');
                card.find('.card-footer').hide();
                card.find('.editar-recibo').show();
                
                const reciboIndex = card.index();
                card.find('.linha-recibo').each(function(index) {
                    previewData.preview[reciboIndex].conteudo[index] = $(this).text();
                });
            });

            // Cancelar edição do recibo
            $(document).on('click', '.cancelar-edicao', function() {
                const card = $(this).closest('.card');
                const reciboIndex = card.index();
                
                card.find('.linha-recibo').each(function(index) {
                    $(this).text(previewData.preview[reciboIndex].conteudo[index]);
                });
                
                card.find('.linha-recibo').attr('contenteditable', 'false');
                card.find('.card-footer').hide();
                card.find('.editar-recibo').show();
            });

            // Download dos recibos
            $('#downloadRecibos').click(function(e) {
                e.preventDefault();
                fetch('/download_recibos')
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'recibos.zip';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    })
                    .catch(error => {
                        console.error('Erro no download:', error);
                        alert('Erro ao baixar os recibos');
                    });
            });
      $(document).ready(function() {
          function formatarValor(valor) {
              valor = valor.replace(/\D/g, '');
              valor = (parseInt(valor) / 100).toFixed(2);
              valor = valor.replace('.', ',');
              valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
              return valor;
          }

          $('#valor').on('input', function() {
              let valorAtual = $(this).val().replace(/\D/g, '');
              if (valorAtual) {
                  $(this).val(formatarValor(valorAtual));
              }
          });
      });
</script>  
   
<footer class="bg-light py-3 text-center mt-5">
    <p class="mb-0">Desenvolvido por Leandro Leal - 2025</p>
</footer>

</body>
</html>





