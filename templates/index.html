<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Recibos</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    
    <style>
        .select2-container .select2-selection--multiple {
            min-height: 38px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .select2-container {
            width: 100% !important;
            margin-bottom: 10px;
        }
        
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Gerador de Recibos</h2>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="empresas" class="form-label">Empresas:</label>
                <select id="empresas" class="form-control select2" multiple>
                </select>
            </div>
            <div class="col-md-6">
                <label for="pessoas" class="form-label">Pessoas Físicas:</label>
                <select id="pessoas" class="form-control select2" multiple>
                </select>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <button id="gerarRecibos" class="btn btn-primary">Gerar Recibos</button>
                <button id="downloadRecibos" class="btn btn-success ms-2" style="display: none;">Download</button>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div id="previewArea" style="width: 100%; display: none;">
                    <h3>Prévia dos Recibos</h3>
                    <div id="recibosPreview" class="mt-3">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function() {
            // Inicializa Select2
            $('.select2').select2({
                width: '100%',
                placeholder: 'Selecione os clientes',
                allowClear: true
            });

            // Carrega os clientes
            fetch('/get_clientes')
                .then(response => response.json())
                .then(data => {
                    console.log("Dados recebidos do backend:", data);
                    
                    const empresasSelect = $('#empresas');
                    const pessoasSelect = $('#pessoas');
                    
                    console.log("Preenchendo select de empresas:", data.empresas.length);
                    console.log("Preenchendo select de pessoas:", data.pessoas.length);
                    
                    empresasSelect.empty();
                    pessoasSelect.empty();
                    
                    data.empresas.forEach(empresa => {
                        console.log("Adicionando empresa:", empresa);
                        empresasSelect.append(new Option(empresa, empresa));
                    });
                    
                    data.pessoas.forEach(pessoa => {
                        console.log("Adicionando pessoa:", pessoa);
                        pessoasSelect.append(new Option(pessoa, pessoa));
                    });
                    
                    empresasSelect.trigger('change');
                    pessoasSelect.trigger('change');
                })
                .catch(error => {
                    console.error("Erro ao carregar clientes:", error);
                });        });

            $('#gerarRecibos').click(function() {
                const empresasSelecionadas = $('#empresas').val() || [];
                const pessoasSelecionadas = $('#pessoas').val() || [];
                const todosSelecionados = [...empresasSelecionadas, ...pessoasSelecionadas];

                if (todosSelecionados.length === 0) {
                    alert('Por favor, selecione pelo menos um cliente.');
                    return;
                }

                fetch('/generate_receipts_bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        clientes: todosSelecionados
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const previewArea = $('#previewArea');
                    const recibosPreview = $('#recibosPreview');
                    
                    recibosPreview.empty();
                    
                    data.preview.forEach(recibo => {
                        const reciboHtml = `
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">${recibo.nome}</h5>
                                </div>
                                <div class="card-body">
                                    ${recibo.conteudo.map(linha => `
                                        <p class="${linha.includes('RECIBO') || linha.includes('VALOR') ? 'fw-bold' : ''}">${linha}</p>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        recibosPreview.append(reciboHtml);
                    });
                    
                    previewArea.show();
                    $('#downloadRecibos').show();
                });                                    $('#downloadRecibos').click(function(e) {
                                        e.preventDefault();
                                        fetch('/download_recibos')
                                            .then(response => response.blob())
                                            .then(blob => {
                                                const url = window.URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = 'recibos.zip';
                                                document.body.appendChild(a);
                                                a.click();
                                                window.URL.revokeObjectURL(url);
                                                a.remove();
                                            })
                                            .catch(error => {
                                                console.error('Erro no download:', error);
                                                alert('Erro ao baixar os recibos');
                                            });
                                    });
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao gerar recibos.');
                });
            
    </script>
</body>
</html>